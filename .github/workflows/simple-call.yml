# Simple: Direct HTTP call without Claude Code
#
# This is a lightweight alternative that calls your Railway server directly.
# No AI interpretation - just a scripted phone message.
#
# Secrets needed:
#   - CALLME_API_KEY: Your Call-Me Cloud API key
#   - CALLME_CLOUD_URL: Your Railway deployment URL

name: Simple Call Alert

on:
  workflow_run:
    workflows: ["CI", "Deploy"]
    types: [completed]

  workflow_dispatch:
    inputs:
      message:
        description: 'Message to speak on the call'
        required: true

concurrency:
  group: simple-call
  cancel-in-progress: false

jobs:
  call:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'failure'

    steps:
      - name: Build message
        id: msg
        env:
          MESSAGE_INPUT: ${{ inputs.message }}
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
          REPO_NAME: ${{ github.repository }}
        run: |
          if [ -n "$MESSAGE_INPUT" ]; then
            MSG="$MESSAGE_INPUT"
          else
            MSG="Hey, the ${WORKFLOW_NAME} workflow just failed on ${REPO_NAME}. You might want to take a look. Let me know if you have questions."
          fi
          # Use base64 encoding to safely pass message with special characters
          echo "message=$(echo -n "$MSG" | base64 -w0)" >> $GITHUB_OUTPUT

      - name: Initiate call
        id: call
        env:
          CALLME_URL: ${{ secrets.CALLME_CLOUD_URL }}
          CALLME_KEY: ${{ secrets.CALLME_API_KEY }}
          MSG_B64: ${{ steps.msg.outputs.message }}
        run: |
          MSG=$(echo "$MSG_B64" | base64 -d)
          RESPONSE=$(curl -sf -X POST "${CALLME_URL}/api/call" \
            -H "Authorization: Bearer ${CALLME_KEY}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg msg "$MSG" '{message: $msg}')")

          CALL_ID=$(echo "$RESPONSE" | jq -r '.callId')
          echo "call_id=$CALL_ID" >> $GITHUB_OUTPUT
          echo "Call initiated: $CALL_ID"

      - name: Wait for user response
        run: sleep 45  # Give user time to respond

      - name: End call
        if: always() && steps.call.outputs.call_id != ''
        env:
          CALLME_URL: ${{ secrets.CALLME_CLOUD_URL }}
          CALLME_KEY: ${{ secrets.CALLME_API_KEY }}
          CALL_ID: ${{ steps.call.outputs.call_id }}
        run: |
          curl -sf -X POST "${CALLME_URL}/api/call/${CALL_ID}/end" \
            -H "Authorization: Bearer ${CALLME_KEY}" \
            -H "Content-Type: application/json" \
            -d '{"message": "Alright, I will let you go. Talk to you later!"}' || echo "Failed to end call"
