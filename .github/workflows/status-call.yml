# Example: Phone call status reports via GitHub Actions
#
# Copy this workflow to your repo and configure the secrets:
#   - ANTHROPIC_API_KEY: Your Claude API key
#   - CALLME_API_KEY: Your Call-Me Cloud API key
#   - CALLME_CLOUD_URL: Your Railway deployment URL
#
# Triggers:
#   - Daily at 9 AM UTC on weekdays
#   - After any workflow completes (adjust 'workflows' list as needed)
#   - Manually via workflow_dispatch

name: Status Call

on:
  schedule:
    - cron: '0 9 * * 1-5'  # 9 AM UTC, Mon-Fri

  workflow_run:
    workflows: ["CI", "Deploy"]  # Add your workflow names
    types: [completed]

  workflow_dispatch:
    inputs:
      prompt:
        description: 'Custom prompt for Claude (what should the call be about?)'
        required: false
        default: ''

# Prevent concurrent calls
concurrency:
  group: status-call
  cancel-in-progress: false

jobs:
  call:
    runs-on: ubuntu-latest
    # Only run on failures, or for scheduled/manual triggers
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'failure'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 10  # Get recent history for context

      - name: Gather context
        id: ctx
        env:
          EVENT_NAME: ${{ github.event_name }}
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
          WORKFLOW_STATUS: ${{ github.event.workflow_run.conclusion }}
        run: |
          # Basic repo info
          echo "repo=${{ github.repository }}" >> $GITHUB_OUTPUT
          echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "latest_commit=$(git log -1 --pretty='%s')" >> $GITHUB_OUTPUT

          # Recent commits
          COMMITS=$(git log --oneline -5 | head -c 500)
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Trigger info (use env vars to avoid injection)
          echo "event=${EVENT_NAME}" >> $GITHUB_OUTPUT
          if [ "${EVENT_NAME}" = "workflow_run" ]; then
            echo "workflow_name=${WORKFLOW_NAME}" >> $GITHUB_OUTPUT
            echo "workflow_status=${WORKFLOW_STATUS}" >> $GITHUB_OUTPUT
          fi

      - name: Configure MCP for call-me-cloud
        env:
          CALLME_CLOUD_URL: ${{ secrets.CALLME_CLOUD_URL }}
          CALLME_API_KEY: ${{ secrets.CALLME_API_KEY }}
        run: |
          cat > /tmp/mcp-config.json << EOF
          {
            "mcpServers": {
              "call-me-cloud": {
                "type": "stdio",
                "command": "npx",
                "args": ["-y", "call-me-cloud-mcp@latest"],
                "env": {
                  "CALLME_CLOUD_URL": "${CALLME_CLOUD_URL}",
                  "CALLME_API_KEY": "${CALLME_API_KEY}"
                }
              }
            }
          }
          EOF

      - name: Build prompt
        id: prompt
        env:
          CUSTOM_PROMPT: ${{ inputs.prompt }}
          EVENT_TYPE: ${{ steps.ctx.outputs.event }}
          WORKFLOW_NAME: ${{ steps.ctx.outputs.workflow_name }}
          REPO_NAME: ${{ steps.ctx.outputs.repo }}
          BRANCH_NAME: ${{ steps.ctx.outputs.branch }}
          LATEST_COMMIT: ${{ steps.ctx.outputs.latest_commit }}
          RECENT_COMMITS: ${{ steps.ctx.outputs.commits }}
        run: |
          if [ -n "$CUSTOM_PROMPT" ]; then
            PROMPT="$CUSTOM_PROMPT"
          elif [ "$EVENT_TYPE" = "workflow_run" ]; then
            PROMPT="URGENT: Call the user immediately. The ${WORKFLOW_NAME} workflow just FAILED on ${REPO_NAME}. Latest commit: ${LATEST_COMMIT}. Branch: ${BRANCH_NAME}. Keep it brief but get their attention. Ask if they want details or help debugging."
          else
            PROMPT="Call the user with a quick daily status update for ${REPO_NAME}. Recent activity: ${RECENT_COMMITS}. Keep it conversational. Ask if they want to discuss any recent changes or priorities."
          fi
          # Use heredoc for multiline output
          {
            echo "content<<PROMPT_EOF"
            echo "$PROMPT"
            echo "PROMPT_EOF"
          } >> $GITHUB_OUTPUT

      - name: Make the call
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: ${{ steps.prompt.outputs.content }}
          claude_args: |
            --mcp-config /tmp/mcp-config.json
            --allowedTools mcp__call-me-cloud__initiate_call,mcp__call-me-cloud__continue_call,mcp__call-me-cloud__speak_to_user,mcp__call-me-cloud__end_call
          max_turns: "20"
