# Scheduled Call with Dynamic Prompt
#
# Trigger from any Claude session:
#   gh workflow run scheduled-call.yml --repo OWNER/REPO \
#     -f delay_minutes=5 \
#     -f prompt="Discuss the auth refactor" \
#     -f branch="feat/auth-refactor"
#
# Secrets needed:
#   - ANTHROPIC_API_KEY
#   - CALLME_API_KEY
#   - CALLME_CLOUD_URL

name: Scheduled Call

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: 'What should Claude discuss/work on?'
        required: true
        type: string
      delay_minutes:
        description: 'Minutes to wait before calling (0 = immediate, max 300)'
        required: false
        default: '0'
        type: string
      branch:
        description: 'Branch name for commits (leave empty to auto-generate)'
        required: false
        default: ''
        type: string

concurrency:
  group: scheduled-call-${{ github.run_id }}
  cancel-in-progress: false

jobs:
  call:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # GitHub-hosted runner max is 6 hours

    steps:
      - name: Wait for scheduled time
        if: inputs.delay_minutes != '0'
        env:
          DELAY_INPUT: ${{ inputs.delay_minutes }}
        run: |
          # Sanitize: extract only digits, default to 0
          # Cap at 300 min (5 hours) to leave time for the call itself
          # Note: GitHub-hosted runners max out at 6 hours total
          DELAY=$(echo "$DELAY_INPUT" | tr -cd '0-9')
          DELAY=${DELAY:-0}
          if [ "$DELAY" -gt 300 ]; then
            echo "âš ï¸ Delay capped at 300 minutes (GitHub-hosted runner limit)"
            DELAY=300
          fi
          echo "â° Waiting $DELAY minutes before calling..."
          sleep "${DELAY}m"
          echo "âœ“ Delay complete, initiating call"

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup branch
        id: branch
        env:
          BRANCH_INPUT: ${{ inputs.branch }}
        run: |
          # Sanitize: allow only alphanumeric, dash, underscore, slash
          SAFE_BRANCH=$(echo "$BRANCH_INPUT" | tr -cd 'a-zA-Z0-9/_-')
          if [ -n "$SAFE_BRANCH" ]; then
            BRANCH="$SAFE_BRANCH"
          else
            BRANCH="claude/call-$(date +%Y%m%d-%H%M%S)"
          fi
          echo "name=$BRANCH" >> $GITHUB_OUTPUT
          git checkout -B "$BRANCH" 2>/dev/null || git checkout "$BRANCH"
          echo "ğŸ“ Using branch: $BRANCH"

      - name: Configure git
        run: |
          git config user.name "Claude (GitHub Actions)"
          git config user.email "claude@github-actions.local"

      - name: Configure MCP for call-me-cloud
        env:
          CALLME_CLOUD_URL: ${{ secrets.CALLME_CLOUD_URL }}
          CALLME_API_KEY: ${{ secrets.CALLME_API_KEY }}
        run: |
          cat > /tmp/mcp-config.json << EOF
          {
            "mcpServers": {
              "call-me-cloud": {
                "type": "stdio",
                "command": "npx",
                "args": ["-y", "call-me-cloud-mcp@latest"],
                "env": {
                  "CALLME_CLOUD_URL": "${CALLME_CLOUD_URL}",
                  "CALLME_API_KEY": "${CALLME_API_KEY}"
                }
              }
            }
          }
          EOF

      - name: Build prompt
        id: prompt
        env:
          USER_TOPIC: ${{ inputs.prompt }}
          REPO_NAME: ${{ github.repository }}
          BRANCH_NAME: ${{ steps.branch.outputs.name }}
        run: |
          {
            echo "content<<PROMPT_EOF"
            cat << EOF
          You are running in GitHub Actions for ${REPO_NAME}.

          INSTRUCTIONS:
          1. IMMEDIATELY call the user using initiate_call
          2. Discuss the following topic with them
          3. Implement what they request
          4. Commit changes to branch: ${BRANCH_NAME}
          5. Before ending, summarize what you did

          TOPIC: ${USER_TOPIC}

          This is a phone conversation while they're walking. Keep it conversational.
          EOF
            echo "PROMPT_EOF"
          } >> $GITHUB_OUTPUT

      - name: Run Claude with call capability
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: ${{ steps.prompt.outputs.content }}
          claude_args: |
            --mcp-config /tmp/mcp-config.json
            --allowedTools mcp__call-me-cloud__initiate_call,mcp__call-me-cloud__continue_call,mcp__call-me-cloud__speak_to_user,mcp__call-me-cloud__end_call,Read,Edit,Write,Glob,Grep
          max_turns: "50"

      - name: Push changes
        run: |
          if git log origin/${{ github.ref_name }}..${{ steps.branch.outputs.name }} --oneline 2>/dev/null | grep -q .; then
            git push -u origin ${{ steps.branch.outputs.name }}
            echo "ğŸš€ Pushed: https://github.com/${{ github.repository }}/tree/${{ steps.branch.outputs.name }}"
          else
            echo "â„¹ï¸ No commits to push"
          fi
